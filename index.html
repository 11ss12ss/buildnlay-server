<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuildNPlay Gaming Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- Global Animations & Effects --- */

        @keyframes coinPulse {
            0% { box-shadow: 0 0 5px gold, 0 0 10px gold; }
            50% { box-shadow: 0 0 10px gold, 0 0 20px gold; }
            100% { box-shadow: 0 0 5px gold, 0 0 10px gold; }
        }

        .page {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* --- Moderation Banner Style --- */
        #moderationBanner {
            padding: 15px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.5s ease-out;
        }

        .ban-banner {
            background: linear-gradient(90deg, #8b0000, #b22222);
            border: 2px solid #ff0000;
        }

        .warn-banner {
            background: linear-gradient(90deg, #a0522d, #ff8c00);
            border: 2px solid #ffd700;
        }

        /* --- Auth Screen Styles --- */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        #loginSuccessScreen {
            display: none;
            text-align: center;
            padding: 50px;
            border-radius: 20px;
            background: rgba(26, 33, 62, 0.9);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.5);
            animation: fadeInScale 0.5s ease-out;
            max-width: 500px;
            width: 90%;
            z-index: 2000;
            position: fixed;
        }

        #loginSuccessScreen h2 {
            font-size: 48px;
            margin-bottom: 10px;
            color: #ffd700;
        }

        #loginSuccessScreen p {
            font-size: 20px;
            color: #00ffaa;
            margin-bottom: 30px;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .auth-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .auth-box h2 {
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff4444;
            color: #ff4444;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .toggle-btn {
            background: transparent;
            color: #aaa;
            margin-top: 10px;
        }
        
        .toggle-btn:hover {
            color: white;
            transform: none;
            box-shadow: none;
        }

        /* --- Navigation Styles --- */
        nav {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #00ffaa, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            width: auto;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #a795ff, #8a70ff);
            box-shadow: 0 0 15px rgba(138, 112, 255, 0.5);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .coins-display {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid gold;
            padding: 10px 20px;
            border-radius: 10px;
            color: gold;
            font-weight: bold;
            animation: coinPulse 2s infinite alternate;
        }

        .user-identity {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .level-badge {
            background: #667eea;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .admin-tag {
            color: #ff4444;
            font-weight: bold;
            background: rgba(255, 68, 68, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* --- Home Page Styles --- */
        .page-title {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .quote-box {
            background: rgba(255, 255, 255, 0.05);
            border-left: 5px solid #00ffaa;
            padding: 20px;
            border-radius: 10px;
            font-style: italic;
            color: #00ffaa;
            margin: 40px auto;
            max-width: 800px;
            text-align: center;
            transition: all 0.5s;
        }
        .quote-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 255, 170, 0.3);
        }

        .stats-summary {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            width: 150px;
            transition: all 0.3s;
        }
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .xp-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 50px;
            text-align: center;
        }
        .xp-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .progress-bar-container {
            width: 100%;
            height: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 1s ease-out;
        }

        /* --- Game Grid Styles --- */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            border-top: 4px solid #667eea;
            transition: all 0.3s;
        }

        .game-card:hover {
            animation: cardWiggle 0.3s ease-in-out;
        }
        @keyframes cardWiggle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .game-icon { font-size: 60px; margin-bottom: 15px; }
        .game-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .game-desc { color: #aaa; margin-bottom: 20px; }

        .badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; }
        .badge-easy { background: rgba(0, 255, 0, 0.2); color: #0f0; }
        .badge-medium { background: rgba(255, 165, 0, 0.2); color: #ffa500; }
        .badge-hard { background: rgba(255, 0, 0, 0.2); color: #ff4444; }

        .play-btn { width: 100%; }

        /* --- Shop/Admin Table Styles --- */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .shop-item:hover {
            transform: scale(1.05);
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .shop-icon { font-size: 60px; margin-bottom: 15px; }
        .buy-btn { margin-top: 15px; }

        table { width: 100%; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; }
        th { background: rgba(0, 0, 0, 0.3); }
        tr:hover { background: rgba(255, 255, 255, 0.05); }

        .admin-actions button { width: auto; padding: 8px 15px; font-size: 12px; margin-right: 5px; }
        .admin-actions .ban-btn { background: #ff4444; }
        .admin-actions .unban-btn { background: #008000; }
        .admin-actions .warn-btn { background: #ffa500; }
        .admin-actions .clear-btn { background: #333; }

        /* --- UGC Styles --- */
        .creations-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .creation-submission { background: rgba(255, 255, 255, 0.1); padding: 30px; border-radius: 20px; }
        .creation-card { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; border-left: 5px solid #667eea; }

        /* --- Modal and Notification Styles --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            text-align: center;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .modal-title {
            font-size: 32px;
        }
        
        .game-stats {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 20px 0;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }
        
        #gameCanvas {
            width: 100%;
            height: 400px;
            background: #000;
            border: 2px solid #667eea;
            margin-bottom: 10px;
        }
        
        .controls {
            color: #aaa;
        }
        
        .close-btn {
            width: auto;
            padding: 10px 20px;
            background: #ff4444;
        }

        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Success Overlay -->
    <div id="loginSuccessScreen" class="auth-screen">
        <h2>Welcome Back!</h2>
        <p id="welcomeQuote">A legend never quits.</p>
        <button onclick="hideLoginSuccess()" style="width: 200px;">Enter Platform</button>
    </div>

    <div id="authScreen" class="auth-screen">
        <div class="auth-box">
            <h2 id="authTitle">🎮 Welcome Back!</h2>
            <p id="authSubtitle" style="color: #aaa; margin-bottom: 30px;">Login to continue</p>
            <div id="errorMsg" class="error hidden"></div>
            <input type="text" id="username" placeholder="Username">
            <div id="emailField" class="hidden">
                <input type="email" id="email" placeholder="Email">
            </div>
            <input type="password" id="password" placeholder="Password">
            <div id="confirmField" class="hidden">
                <input type="password" id="confirmPassword" placeholder="Confirm Password">
            </div>
            <button id="authBtn" onclick="handleAuth()">Login</button>
            <button class="toggle-btn" onclick="toggleAuth()">Don't have an account? Sign up</button>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <nav>
            <div class="logo">🎮 BuildNPlay</div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('home', this)">Home</button>
                <button class="nav-btn" onclick="showPage('shop', this)">Shop</button>
                <button class="nav-btn" onclick="showPage('inventory', this)">Inventory</button>
                <button class="nav-btn" onclick="showPage('leaderboard', this)">Leaderboard</button>
                <button class="nav-btn" onclick="showPage('creations', this)">Creations</button>
                <button class="nav-btn" id="adminBtn" onclick="showPage('admin', this)" style="display:none;">Admin</button>
            </div>
            <div class="user-info">
                <div class="coins-display">💰 <span id="coinsDisplay">0</span></div>
                <div class="user-identity">
                    <span id="usernameDisplay"></span>
                    <span id="adminTag" class="admin-tag hidden">[ADMIN]</span>
                    <span class="level-badge">Lvl <span id="levelDisplay">1</span></span>
                </div>
                <button class="nav-btn" onclick="logout()">Logout</button>
            </div>
        </nav>
        
        <!-- MODERATION STATUS BANNER -->
        <div id="moderationBanner" class="hidden"></div> 

        <div class="container">
            <div id="homePage" class="page">
                <div style="text-align: center; margin: 40px 0;">
                    <h1 class="page-title">Welcome back, <span id="welcomeName"></span>! 🚀</h1>
                </div>

                <!-- Quote of the Day -->
                <div class="quote-box">
                    <p id="quoteOfTheDay">"The only way to win is to never stop building." - BnP</p>
                </div>

                <!-- User Stats Summary -->
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="statsLevel">1</div>
                        <div class="stat-label">Current Level</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statsGames">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statsScore">0</div>
                        <div class="stat-label">Total Score</div>
                    </div>
                </div>

                <!-- XP Progress Bar -->
                <div class="xp-container">
                    <div class="xp-text">
                        <span>XP: <span id="statsXP">0</span></span>
                        <span>Next Level: <span id="xpNeeded">500</span> XP</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="xpProgressBar" style="width: 0%;"></div>
                    </div>
                </div>

                <h2>Explore Games</h2>
                <div class="game-grid" id="gamesContainer"></div>
            </div>

            <div id="shopPage" class="page hidden">
                <h1 class="page-title">🛒 Item Shop</h1>
                <div class="shop-grid" id="shopContainer"></div>
            </div>

            <div id="inventoryPage" class="page hidden">
                <h1 class="page-title">📦 Your Inventory</h1>
                <div class="shop-grid" id="inventoryContainer"></div>
            </div>

            <div id="leaderboardPage" class="page hidden">
                <h1 class="page-title">🏆 Global Leaderboard</h1>
                <table id="leaderboardTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Level</th>
                            <th>Total Score</th>
                            <th>Games Played</th>
                            <th>Coins</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>

            <div id="creationsPage" class="page hidden">
                <h1 class="page-title">🛠️ Player Creations (UGC)</h1>
                <div class="creations-grid">
                    <div class="creation-submission">
                        <h3>Submit Your Idea!</h3>
                        <input type="text" id="creationTitle" placeholder="Idea Title (e.g., Space Cruiser Game)">
                        <select id="creationType">
                            <option value="Game">Game Idea</option>
                            <option value="Item">Shop Item</option>
                            <option value="Map">Map/Level Design</option>
                            <option value="Other">Other</option>
                        </select>
                        <textarea id="creationDesc" rows="4" placeholder="Describe your creation in detail..."></textarea>
                        <button onclick="submitCreation()">Submit Idea</button>
                    </div>
                    <div>
                        <h3>Recent Submissions</h3>
                        <div id="submissionsContainer" style="display: flex; flex-direction: column; gap: 15px;">
                            <p style="color:#aaa; text-align:center; padding: 50px;">No submissions yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="adminPage" class="page hidden">
                <h1 class="page-title">🛡️ Admin Panel</h1>
                <h2>User Management</h2>
                <table id="adminTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Status</th>
                            <th>Level</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminBody"></tbody>
                </table>
                <h2 style="margin-top: 40px;">UGC Submissions (<span id="adminSubmissionCount">0</span>)</h2>
                <table id="adminUgcTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>User</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminUgcBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="gameTitle">Game</h2>
                <button class="close-btn" onclick="closeGame()">✕ Exit</button>
            </div>
            <div class="game-stats">
                <div class="stat">
                    <div class="stat-value" id="scoreDisplay">0</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: gold;" id="gameCoinsDisplay">0</div>
                    <div class="stat-label">Coins</div>
                </div>
            </div>
            <canvas id="gameCanvas"></canvas>
            <div class="controls">Use Arrow Keys or A/D to move</div>
        </div>
    </div>

    <div id="notification" class="notification hidden"></div>

    <script>
        let currentUser = null;
        let isLogin = true;
        let gameLoop = null;
        let currentGame = null;
        let nextCreationId = 1;

        const QUOTES = [
            "The only way to win is to never stop building.",
            "Greatness is not a destination, it's a journey of pixels.",
            "May your framerate be high and your ping be low.",
            "In this world, we play to create.",
            "Don't just chase the score, chase the story."
        ];

        const users = [
            { username: 'admin', password: 'admin123', email: 'admin@bp.com', role: 'admin', level: 10, xp: 1200, coins: 50000, inventory: [], banned: false, banReason: null, warned: false, stats: { gamesPlayed: 25, totalScore: 15000 }, firstLogin: false },
            { username: 'player1', password: 'pass123', email: 'p1@bp.com', role: 'user', level: 3, xp: 450, coins: 2500, inventory: [], banned: false, banReason: null, warned: false, stats: { gamesPlayed: 5, totalScore: 1200 }, firstLogin: false }
        ];

        const UGC_SUBMISSIONS = []; 

        const GAMES = [
            { id: 1, name: 'Cosmic Runner', desc: 'Dodge asteroids and collect stars!', icon: '🚀', difficulty: 'Easy', reward: 100, xp: 50, color: '#667eea' },
            { id: 2, name: 'Coin Catcher', desc: 'Catch falling coins!', icon: '💰', difficulty: 'Easy', reward: 150, xp: 60, color: '#ffd700' },
            { id: 3, name: 'Crystal Miner', desc: 'Dig deep for rare crystals!', icon: '💎', difficulty: 'Medium', reward: 250, xp: 80, color: '#00ffaa' },
            { id: 4, name: 'Stealth Grid', desc: 'Avoid security lasers!', icon: '⚫', difficulty: 'Hard', reward: 300, xp: 90, color: '#ff6666' }
        ];

        const SHOP = [
            { id: 1, name: 'Fire Sword', desc: 'Legendary melee weapon', icon: '🔥', price: 5000 },
            { id: 2, name: 'Diamond Shield', desc: 'Ultimate protection', icon: '💎', price: 7500 },
            { id: 3, name: 'Speed Boots', desc: '+50% movement speed', icon: '👟', price: 3000 },
            { id: 4, name: 'Golden Crown', desc: 'Show your status', icon: '👑', price: 20000 },
            { id: 5, name: 'XP Booster', desc: 'Double XP for 1 hour', icon: '✨', price: 1000 },
            { id: 6, name: 'Health Potion', desc: 'Full restore in-game', icon: '🧪', price: 800 },
            { id: 7, name: 'Master Key', desc: 'Opens all special chests', icon: '🔑', price: 15000 }
        ];

        // --- Auth Functions ---

        function hideLoginSuccess() {
            document.getElementById('loginSuccessScreen').style.display = 'none';
        }

        function toggleAuth() {
            isLogin = !isLogin;
            document.getElementById('authTitle').textContent = isLogin ? '🎮 Welcome Back!' : '🎉 Join BuildNPlay';
            document.getElementById('authSubtitle').textContent = isLogin ? 'Login to continue' : 'Create your account';
            document.getElementById('authBtn').textContent = isLogin ? 'Login' : 'Sign Up';
            document.getElementById('emailField').classList.toggle('hidden');
            document.getElementById('confirmField').classList.toggle('hidden');
            document.querySelector('.toggle-btn').textContent = isLogin ? "Don't have an account? Sign up" : 'Already have an account? Login';
            document.getElementById('errorMsg').classList.add('hidden');
            
            document.getElementById('password').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function handleAuth() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMsg = document.getElementById('errorMsg');

            // Validate inputs
            if (!username || !password) {
                errorMsg.textContent = 'Username and password are required';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (isLogin) {
                const user = users.find(u => u.username === username && u.password === password);
                if (!user) {
                    errorMsg.textContent = 'Invalid username or password';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                // CRUCIAL: Instant Ban Check on Login
                if (user.banned) {
                    let banMessage = '❌ Account BANNED. You cannot log in.';
                    if (user.banReason) {
                        banMessage += ` Reason: ${user.banReason}`;
                    }
                    errorMsg.textContent = banMessage;
                    errorMsg.classList.remove('hidden');
                    return;
                }

                currentUser = user;
                
                // Show Charm Login Success Screen
                if (currentUser.firstLogin) {
                    document.getElementById('welcomeQuote').textContent = "Welcome to the community! Start building your legend.";
                    currentUser.firstLogin = false;
                } else {
                    document.getElementById('welcomeQuote').textContent = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                }
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('loginSuccessScreen').style.display = 'flex';
                
                // Delay showing main app until success screen is dismissed
                setTimeout(showMainApp, 500);
                
            } else {
                const email = document.getElementById('email').value.trim();
                const confirmPassword = document.getElementById('confirmPassword').value.trim();
                
                if (!email) {
                    errorMsg.textContent = 'Email is required';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                if (password.length < 6) {
                    errorMsg.textContent = 'Password must be at least 6 characters';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                if (password !== confirmPassword) {
                    errorMsg.textContent = 'Passwords do not match';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                if (users.find(u => u.username === username)) {
                    errorMsg.textContent = 'Username taken';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                const newUser = {
                    username: username,
                    password: password,
                    email: email,
                    role: 'user',
                    level: 1,
                    xp: 0,
                    coins: 500,
                    inventory: [],
                    banned: false,
                    banReason: null,
                    warned: false,
                    stats: { gamesPlayed: 0, totalScore: 0 },
                    firstLogin: true 
                };
                users.push(newUser);
                
                document.getElementById('username').value = username; 
                document.getElementById('password').value = '';
                document.getElementById('email').value = '';
                document.getElementById('confirmPassword').value = '';
                toggleAuth(); 
                
                errorMsg.classList.add('hidden');
                showNotification('🎉 Account created! Please log in.');
            }
        }

        /**
         * Checks the user's banned or warned status and displays a persistent banner.
         */
        function checkModerationStatus() {
            const banner = document.getElementById('moderationBanner');
            banner.classList.add('hidden');
            banner.className = ''; 

            if (!currentUser) return;

            if (currentUser.banned) {
                const reasonText = currentUser.banReason ? `Reason: ${currentUser.banReason}` : 'No reason provided.';
                banner.textContent = `❌ Account BANNED. You cannot play or access restricted content. (${reasonText})`;
                banner.classList.add('ban-banner');
                banner.classList.remove('hidden');
            } else if (currentUser.warned) {
                banner.textContent = '⚠️ ACCOUNT WARNING: You have a warning. Please adhere to community guidelines.';
                banner.classList.add('warn-banner');
                banner.classList.remove('hidden');
            }
        }

        function showMainApp() {
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('usernameDisplay').textContent = currentUser.username;
            document.getElementById('welcomeName').textContent = currentUser.username;
            
            // Set Admin Tag visibility
            if (currentUser.role === 'admin') {
                document.getElementById('adminBtn').style.display = 'block';
                document.getElementById('adminTag').classList.remove('hidden');
            } else {
                document.getElementById('adminBtn').style.display = 'none';
                document.getElementById('adminTag').classList.add('hidden');
            }

            // Set Quote of the Day on Home Page
            document.getElementById('quoteOfTheDay').textContent = `"${QUOTES[Math.floor(Math.random() * QUOTES.length)]}" - BnP`;
            
            updateUI();
            checkModerationStatus();
            renderGames();
            
            // Ensure first page shown is 'home'
            const homeButton = document.querySelector('.nav-buttons .nav-btn:first-child');
            if (homeButton) {
                showPage('home', homeButton);
            }
        }

        function updateUI() {
            // XP Calculation
            const xpNeededForLevel = currentUser.level * 500;
            const xpPercent = Math.min(100, (currentUser.xp / xpNeededForLevel) * 100);

            document.getElementById('coinsDisplay').textContent = currentUser.coins.toLocaleString();
            document.getElementById('levelDisplay').textContent = currentUser.level;
            
            // Home Page Stats
            document.getElementById('statsLevel').textContent = currentUser.level;
            document.getElementById('statsGames').textContent = currentUser.stats.gamesPlayed;
            document.getElementById('statsScore').textContent = currentUser.stats.totalScore.toLocaleString();

            // XP Bar Update (Animated)
            document.getElementById('statsXP').textContent = currentUser.xp;
            document.getElementById('xpNeeded').textContent = xpNeededForLevel.toLocaleString();
            document.getElementById('xpProgressBar').style.width = xpPercent + '%';

            checkModerationStatus();
        }

        // --- Navigation and Page Functions ---

        function renderGames() {
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '';
            GAMES.forEach(function(game) {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.style.borderTopColor = game.color;
                
                let difficultyBadge;
                if (game.difficulty === 'Easy') difficultyBadge = '<span class="badge badge-easy">' + game.difficulty + '</span>';
                else if (game.difficulty === 'Medium') difficultyBadge = '<span class="badge badge-medium">' + game.difficulty + '</span>';
                else difficultyBadge = '<span class="badge badge-hard">' + game.difficulty + '</span>';

                card.innerHTML = '<div class="game-icon">' + game.icon + '</div>' +
                    '<div class="game-title">' + game.name + '</div>' +
                    '<div class="game-desc">' + game.desc + '</div>' +
                    '<div class="game-info">' +
                    difficultyBadge +
                    '<span class="badge" style="background: rgba(255,215,0,0.2); color: gold;">💰 ' + game.reward + '</span>' +
                    '<span class="badge" style="background: rgba(102,126,234,0.2); color: #667eea;">⭐ ' + game.xp + ' XP</span>' +
                    '</div>' +
                    '<button class="play-btn" onclick="startGame(' + game.id + ')">▶ Play</button>';
                container.appendChild(card);
            });
        }

        function showPage(pageName, element) {
            document.querySelectorAll('.page').forEach(function(p) {
                p.classList.add('hidden');
            });
            document.querySelectorAll('.nav-btn').forEach(function(b) {
                b.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageName + 'Page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            
            if(element) {
                element.classList.add('active');
            } else {
                const button = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.textContent.toLowerCase().includes(pageName));
                if(button) button.classList.add('active');
            }

            if (pageName === 'shop') renderShop();
            if (pageName === 'inventory') renderInventory();
            if (pageName === 'leaderboard') renderLeaderboard();
            if (pageName === 'creations') renderSubmissions();
            if (pageName === 'admin') {
                if (currentUser.role === 'admin') {
                    renderAdmin();
                    renderAdminUgc();
                } else {
                    showNotification('🚫 Access Denied. Admins only.');
                    const homeButton = document.querySelector('.nav-buttons .nav-btn:first-child');
                    if (homeButton) showPage('home', homeButton);
                }
            }
        }

        // --- Shop Functions ---
        function renderShop() {
            const container = document.getElementById('shopContainer');
            container.innerHTML = '';
            SHOP.forEach(function(item) {
                const owned = currentUser.inventory.includes(item.id);
                const canAfford = currentUser.coins >= item.price;
                const card = document.createElement('div');
                card.className = 'shop-item';
                if (owned) card.style.opacity = '0.7';
                card.innerHTML = '<div class="shop-icon">' + item.icon + '</div>' +
                    '<div class="shop-name">' + item.name + '</div>' +
                    '<div style="color: #aaa; font-size: 14px;">' + item.desc + '</div>' +
                    '<div class="shop-price">💰 ' + item.price.toLocaleString() + '</div>' +
                    '<button class="buy-btn" onclick="buyItem(' + item.id + ')" ' + (owned || !canAfford ? 'disabled' : '') + '>' +
                    (owned ? '✓ Owned' : canAfford ? 'Buy Now' : 'Not Enough Coins') +
                    '</button>';
                container.appendChild(card);
            });
        }

        function buyItem(itemId) {
            if (currentUser.banned) {
                showNotification(`🚫 Purchase failed: Your account is banned. Reason: ${currentUser.banReason || 'N/A'}`);
                return;
            }

            const item = SHOP.find(function(i) { return i.id === itemId; });
            if (!item || currentUser.inventory.includes(itemId) || currentUser.coins < item.price) {
                showNotification('🚫 Cannot complete purchase. Not enough coins or already owned.');
                return;
            }
            
            currentUser.coins -= item.price;
            currentUser.inventory.push(itemId);
            updateUI();
            renderShop();
            showNotification('✅ Purchased ' + item.name + '!');
        }

        function renderInventory() {
            const container = document.getElementById('inventoryContainer');
            const ownedItems = SHOP.filter(function(item) {
                return currentUser.inventory.includes(item.id);
            });
            
            if (ownedItems.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding: 80px 0;"><div style="font-size:60px;">📦</div><p style="color:#aaa; font-size:20px; margin-top:20px;">Your inventory is empty!</p><p style="color:#666;">Visit the shop to buy items</p></div>';
            } else {
                container.innerHTML = '';
                ownedItems.forEach(function(item) {
                    const card = document.createElement('div');
                    card.className = 'shop-item';
                    card.style.border = '2px solid #0f0';
                    card.innerHTML = '<div class="shop-icon">' + item.icon + '</div>' +
                        '<div class="shop-name">' + item.name + '</div>' +
                        '<div style="color: #aaa; font-size: 14px;">' + item.desc + '</div>';
                    container.appendChild(card);
                });
            }
        }
        
        // --- UGC/Creations Functions ---
        function submitCreation() {
            if (currentUser.banned) {
                showNotification(`🚫 Submission failed: Your account is banned. Reason: ${currentUser.banReason || 'N/A'}`);
                return;
            }

            const title = document.getElementById('creationTitle').value.trim();
            const type = document.getElementById('creationType').value;
            const desc = document.getElementById('creationDesc').value.trim();

            if (!title || !desc) {
                showNotification('🚫 Title and description are required.');
                return;
            }

            const submission = {
                id: nextCreationId++,
                title: title,
                type: type,
                desc: desc,
                user: currentUser.username,
                date: new Date().toLocaleDateString()
            };

            UGC_SUBMISSIONS.push(submission);
            showNotification('✅ Idea submitted! Thank you.');
            
            document.getElementById('creationTitle').value = '';
            document.getElementById('creationDesc').value = '';
            
            renderSubmissions();
            if (currentUser.role === 'admin' && document.getElementById('adminPage').classList.contains('hidden') === false) {
                renderAdminUgc();
            }
        }
        
        function renderSubmissions() {
            const container = document.getElementById('submissionsContainer');
            if (UGC_SUBMISSIONS.length === 0) {
                container.innerHTML = '<p style="color:#aaa; text-align:center; padding: 50px;">No submissions yet.</p>';
                return;
            }
            
            container.innerHTML = UGC_SUBMISSIONS.slice(-3).reverse().map(sub => `
                <div class="creation-card">
                    <div style="font-weight: bold; font-size: 18px;">${sub.title} (${sub.type})</div>
                    <div style="color: #aaa; margin: 5px 0;">Submitted by: ${sub.user} on ${sub.date}</div>
                    <p style="margin-top: 10px;">${sub.desc.substring(0, 100)}...</p>
                </div>
            `).join('');
        }
        
        function renderAdminUgc() {
            if (currentUser.role !== 'admin') return;
            
            const tbody = document.getElementById('adminUgcBody');
            const countDisplay = document.getElementById('adminSubmissionCount');
            
            countDisplay.textContent = UGC_SUBMISSIONS.length;
            tbody.innerHTML = UGC_SUBMISSIONS.map(sub => `
                <tr>
                    <td style="font-weight: bold;">${sub.title}</td>
                    <td>${sub.type}</td>
                    <td>${sub.user}</td>
                    <td>
                        <button class="nav-btn" onclick="alert('Details:\\nUser: ${sub.user}\\nType: ${sub.type}\\nDesc: ${sub.desc}')" style="width: auto; padding: 5px 10px;">👁️ View</button>
                        <button class="nav-btn" style="width: auto; padding: 5px 10px; background: #ff4444;">🗑️ Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- Leaderboard Functions ---
        function renderLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            const sorted = users.slice().sort(function(a, b) {
                return b.stats.totalScore - a.stats.totalScore;
            });
            tbody.innerHTML = '';
            sorted.forEach(function(user, idx) {
                const tr = document.createElement('tr');
                const medals = ['🥇', '🥈', '🥉'];
                tr.innerHTML = '<td style="font-size:24px; font-weight:bold;">' + (idx < 3 ? medals[idx] : '#' + (idx + 1)) + '</td>' +
                    '<td style="font-weight:bold;">' + user.username + '</td>' +
                    '<td><span class="level-badge">Lvl ' + user.level + '</span></td>' +
                    '<td style="color:#667eea; font-weight:bold;">' + user.stats.totalScore.toLocaleString() + '</td>' +
                    '<td style="color:#aaa;">' + user.stats.gamesPlayed + '</td>' +
                    '<td style="color:gold; font-weight:bold;">' + user.coins.toLocaleString() + '</td>';
                tbody.appendChild(tr);
            });
        }

        // --- Admin Functions ---
        function renderAdmin() {
            if (currentUser.role !== 'admin') return;
            const tbody = document.getElementById('adminBody');
            tbody.innerHTML = '';
            
            users.forEach(function(user) {
                const tr = document.createElement('tr');
                const statusColor = user.banned ? '#f00' : user.warned ? '#ffa500' : '#0f0';
                const statusText = user.banned ? 'Banned' : user.warned ? 'Warned' : 'Active';
                
                tr.innerHTML = '<td style="font-weight:bold;">' + user.username + '</td>' +
                    '<td><span class="badge" style="background: rgba(' + (user.banned ? '255,0,0' : user.warned ? '255,165,0' : '0,255,0') + ',0.2); color: ' + statusColor + ';">' + statusText + (user.banReason ? ' (' + user.banReason + ')' : '') + '</span></td>' +
                    '<td><span class="level-badge">Lvl ' + user.level + '</span></td>' +
                    '<td class="admin-actions">' + (user.role !== 'admin' ? 
                        (user.banned 
                            ? `<button class="unban-btn" onclick="banUser('${user.username}', false)">✅ Unban</button>`
                            : `<button class="ban-btn" onclick="banUser('${user.username}', true)">🚫 Ban</button>`) +
                        (user.warned 
                            ? `<button class="clear-btn" onclick="warnUser('${user.username}', false)">⭐ Clear Warn</button>`
                            : `<button class="warn-btn" onclick="warnUser('${user.username}', true)">⚠️ Warn</button>`)
                        : '') + '</td>';
                tbody.appendChild(tr);
            });
        }

        function banUser(username, shouldBan) {
            const user = users.find(function(u) { return u.username === username; });
            if (!user || user.role === 'admin') return;

            if (shouldBan) {
                const reason = prompt('Enter a reason to ban ' + username + ':');
                if (reason === null || reason.trim() === '') {
                    showNotification('🚫 Ban cancelled. A reason is required.');
                    return;
                }
                user.banned = true;
                user.banReason = reason.trim();
                user.warned = false;
                showNotification('🚫 Banned: ' + username + ' (Reason: ' + user.banReason + ')');
            } else {
                user.banned = false;
                user.banReason = null;
                showNotification('✅ Unbanned: ' + username);
            }
            
            renderAdmin(); 
            
            if (user === currentUser) { 
                checkModerationStatus(); 
                if (user.banned) {
                    showNotification('🚫 You have been banned by another admin. Logging out...');
                    setTimeout(logout, 1500); 
                }
            }
        }
        
        function warnUser(username, shouldWarn) {
            const user = users.find(function(u) { return u.username === username; });
            if (!user || user.role === 'admin' || user.banned) return;

            if (shouldWarn) {
                user.warned = true;
                showNotification('⚠️ Warned: ' + username);
            } else {
                user.warned = false;
                showNotification('✅ Warn cleared: ' + username);
            }
            
            renderAdmin(); 
            
            if (user === currentUser) {
                checkModerationStatus();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            
            document.getElementById('username').value = ''; 
            document.getElementById('password').value = ''; 
            
            if (!isLogin) toggleAuth();
            showNotification('👋 Logged out successfully. See you soon!');
        }

        function showNotification(msg) {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.classList.remove('hidden');
            setTimeout(function() {
                notif.classList.add('hidden');
            }, 3000);
        }

        // --- Game Logic ---
        
        let player = { x: 0, y: 0, size: 20, speed: 5 };
        let obstacles = [];
        let score = 0;
        let gameCoins = 0;
        let canvas, ctx;

        function startGame(gameId) {
            if (currentUser.banned) {
                showNotification(`🚫 Cannot start game: Your account is banned. Reason: ${currentUser.banReason || 'N/A'}`);
                return;
            }

            currentGame = GAMES.find(function(g) { return g.id === gameId; });
            document.getElementById('gameModal').classList.add('active');
            document.getElementById('gameTitle').textContent = currentGame.name;
            
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            score = 0;
            gameCoins = 0;
            player.x = canvas.width / 2;
            player.y = canvas.height - player.size - 10;
            obstacles = [];
            
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('gameCoinsDisplay').textContent = gameCoins;

            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(updateGame, 1000 / 60);
            
            document.addEventListener('keydown', handleKeyPress);
            document.addEventListener('keyup', handleKeyRelease);
        }

        function closeGame() {
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = null;
            }
            
            document.getElementById('gameModal').classList.remove('active');
            
            document.removeEventListener('keydown', handleKeyPress);
            document.removeEventListener('keyup', handleKeyRelease);
            
            keys = {};
            
            if (score > 0 && !currentUser.banned) {
                const finalCoins = Math.floor(score / 100) * currentGame.reward + gameCoins;
                const finalXP = Math.floor(score / 100) * currentGame.xp;
                
                currentUser.coins += finalCoins;
                currentUser.xp += finalXP;
                currentUser.stats.gamesPlayed++;
                currentUser.stats.totalScore += score;

                let xpNeededForLevel = currentUser.level * 500;
                while (currentUser.xp >= xpNeededForLevel) {
                    currentUser.xp -= xpNeededForLevel;
                    currentUser.level++;
                    xpNeededForLevel = currentUser.level * 500;
                    showNotification(`🏆 Level Up! You are now Level ${currentUser.level}!`);
                }

                updateUI();
                showNotification(`🎉 Game Over! +${finalCoins} Coins, +${finalXP} XP`);
            } else if (score > 0 && currentUser.banned) {
                showNotification('Game ended. No rewards earned while banned.');
            } else {
                showNotification('Game session ended.');
            }
        }

        let keys = {};
        function handleKeyPress(e) {
            keys[e.key] = true;
        }

        function handleKeyRelease(e) {
            keys[e.key] = false;
        }

        function updateGame() {
            if (currentUser.banned) {
                if (gameLoop) {
                    clearInterval(gameLoop);
                    gameLoop = null;
                }
                document.removeEventListener('keydown', handleKeyPress);
                document.removeEventListener('keyup', handleKeyRelease);
                document.getElementById('gameModal').classList.remove('active');
                showNotification('🚫 Game ended: Your account was banned by an admin.');
                checkModerationStatus();
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (keys['ArrowLeft'] || keys['a']) {
                player.x = Math.max(player.size / 2, player.x - player.speed);
            }
            if (keys['ArrowRight'] || keys['d']) {
                player.x = Math.min(canvas.width - player.size / 2, player.x + player.speed);
            }

            ctx.fillStyle = currentGame.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size / 2, 0, Math.PI * 2);
            ctx.fill();
            
            if (Math.random() < 0.03) {
                const type = Math.random() < 0.8 ? 'obstacle' : 'coin';
                obstacles.push({
                    x: Math.random() * (canvas.width - 40) + 20,
                    y: -30,
                    size: type === 'coin' ? 15 : 25,
                    speed: Math.random() * 2 + 1,
                    type: type,
                    icon: type === 'coin' ? '💰' : '☄️'
                });
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.y += obs.speed;
                
                ctx.font = `${obs.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(obs.icon, obs.x, obs.y);

                const dx = player.x - obs.x;
                const dy = player.y - obs.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.size / 2 + obs.size / 2) {
                    if (obs.type === 'coin') {
                        gameCoins += 100;
                        score += 100;
                        document.getElementById('gameCoinsDisplay').textContent = gameCoins;
                        document.getElementById('scoreDisplay').textContent = score;
                    } else if (obs.type === 'obstacle') {
                        clearInterval(gameLoop);
                        gameLoop = null;
                        showNotification('💥 You hit an obstacle! Game Over.');
                        setTimeout(closeGame, 1500);
                        return;
                    }
                    obstacles.splice(i, 1);
                } else if (obs.y > canvas.height + 30) {
                    obstacles.splice(i, 1);
                    if (obs.type === 'obstacle') {
                         score += 10;
                         document.getElementById('scoreDisplay').textContent = score;
                    }
                }
            }
        }
    </script>
</body>
</html>
